#!/bin/bash
# X (Twitter) Downloads Cleaner
# Usage: x-channel-clear [@username] [options]

DOWNLOAD_DIR="$HOME/x-downloads"
ARCHIVE_FILE="$DOWNLOAD_DIR/.download-archive.txt"
CSV_LOG="$DOWNLOAD_DIR/download-history.csv"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse arguments
USERNAME=""
OLDER_THAN=""
DELETE_ALL=false
CONFIRM=false
DRY_RUN=false
MEDIA_FILTER=""

for arg in "$@"; do
    case $arg in
        --all|-A)
            DELETE_ALL=true
            ;;
        --confirm|-y)
            CONFIRM=true
            ;;
        --dry-run|-n)
            DRY_RUN=true
            ;;
        --video|-v)
            MEDIA_FILTER="video"
            ;;
        --image|-i)
            MEDIA_FILTER="image"
            ;;
        --help|-h)
            USERNAME="--help"
            ;;
        *)
            if [[ "$arg" =~ ^[0-9]+$ ]] && [ -z "$OLDER_THAN" ]; then
                OLDER_THAN="$arg"
            elif [ -z "$USERNAME" ]; then
                USERNAME="$arg"
            fi
            ;;
    esac
done

# Help
if [ "$USERNAME" = "--help" ]; then
    echo -e "${GREEN}X (Twitter) Downloads Cleaner${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC} x-channel-clear [@username] [options]"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  x-channel-clear                           # List all accounts"
    echo "  x-channel-clear @username --confirm       # Delete all from account"
    echo "  x-channel-clear @username --older 30 -y   # Delete older than 30 days"
    echo "  x-channel-clear --all --confirm           # Delete everything"
    echo "  x-channel-clear @username --video -y      # Delete only videos"
    echo "  x-channel-clear @username --dry-run       # Preview without deleting"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  --older <days>      Only delete files older than N days"
    echo "  --video, -v         Only delete video files"
    echo "  --image, -i         Only delete image files"
    echo "  --all, -A           Delete all downloads"
    echo "  --confirm, -y       Actually delete (required)"
    echo "  --dry-run, -n       Preview without deleting"
    echo "  --help, -h          Show this help"
    echo ""
    echo -e "${YELLOW}Storage:${NC}"
    echo "  Files:    ~/x-downloads/"
    exit 0
fi

# Check if download directory exists
if [ ! -d "$DOWNLOAD_DIR" ]; then
    echo -e "${YELLOW}No X downloads directory found.${NC}"
    exit 0
fi

# List accounts if no specific one given
if [ -z "$USERNAME" ] && [ "$DELETE_ALL" = false ]; then
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Downloaded X Accounts${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""

    for dir in "$DOWNLOAD_DIR"/@*/; do
        if [ -d "$dir" ]; then
            ACCOUNT_NAME=$(basename "$dir")
            FILE_COUNT=$(find "$dir" -type f \( -name "*.mp4" -o -name "*.jpg" -o -name "*.png" -o -name "*.gif" \) 2>/dev/null | wc -l)
            DIR_SIZE=$(du -sh "$dir" 2>/dev/null | cut -f1)

            if [ "$FILE_COUNT" -gt 0 ]; then
                echo -e "${YELLOW}$ACCOUNT_NAME${NC}"
                echo -e "  Files: $FILE_COUNT | Size: $DIR_SIZE"
            fi
        fi
    done

    TOTAL_SIZE=$(du -sh "$DOWNLOAD_DIR" 2>/dev/null | cut -f1)

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "Total size: ${YELLOW}$TOTAL_SIZE${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "To delete: ${BLUE}x-channel-clear @username --confirm${NC}"
    exit 0
fi

# Normalize username
USERNAME=$(echo "$USERNAME" | sed 's|^@||')
if [ "$DELETE_ALL" = false ]; then
    TARGET_DIR="$DOWNLOAD_DIR/@$USERNAME"
    TARGET_NAME="@$USERNAME"

    if [ ! -d "$TARGET_DIR" ]; then
        echo -e "${RED}Account not found: @$USERNAME${NC}"
        echo "Available accounts:"
        ls -1 "$DOWNLOAD_DIR" 2>/dev/null | grep "^@"
        exit 1
    fi
else
    TARGET_DIR="$DOWNLOAD_DIR"
    TARGET_NAME="ALL X DOWNLOADS"
fi

# Build find command
FIND_OPTS="-type f \( -name '*.mp4' -o -name '*.jpg' -o -name '*.png' -o -name '*.gif' -o -name '*.webp' -o -name '*.mov' \)"

if [ -n "$MEDIA_FILTER" ]; then
    if [ "$MEDIA_FILTER" = "video" ]; then
        FIND_OPTS="-type f \( -name '*.mp4' -o -name '*.mov' -o -name '*.webm' \)"
    else
        FIND_OPTS="-type f \( -name '*.jpg' -o -name '*.jpeg' -o -name '*.png' -o -name '*.gif' -o -name '*.webp' \)"
    fi
fi

if [ -n "$OLDER_THAN" ]; then
    FIND_OPTS="$FIND_OPTS -mtime +$OLDER_THAN"
fi

# Find files
FILES_TO_DELETE=$(eval "find \"$TARGET_DIR\" $FIND_OPTS" 2>/dev/null)

if [ -z "$FILES_TO_DELETE" ]; then
    echo -e "${YELLOW}No files found matching criteria.${NC}"
    exit 0
fi

FILE_COUNT=$(echo "$FILES_TO_DELETE" | wc -l)
TOTAL_SIZE=$(echo "$FILES_TO_DELETE" | xargs du -ch 2>/dev/null | tail -1 | cut -f1)

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Files to Delete${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Target:  ${YELLOW}$TARGET_NAME${NC}"
[ -n "$OLDER_THAN" ] && echo -e "Filter:  ${YELLOW}Older than $OLDER_THAN days${NC}"
[ -n "$MEDIA_FILTER" ] && echo -e "Media:   ${YELLOW}$MEDIA_FILTER only${NC}"
echo -e "Files:   ${RED}$FILE_COUNT${NC}"
echo -e "Size:    ${RED}$TOTAL_SIZE${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# List files
echo -e "${YELLOW}Files:${NC}"
echo "$FILES_TO_DELETE" | while read -r file; do
    SIZE=$(du -h "$file" 2>/dev/null | cut -f1)
    echo "  $SIZE  $(basename "$file")"
done | head -20

if [ "$FILE_COUNT" -gt 20 ]; then
    echo "  ... and $((FILE_COUNT - 20)) more files"
fi
echo ""

# Dry run
if [ "$DRY_RUN" = true ]; then
    echo -e "${BLUE}[DRY RUN] No files deleted.${NC}"
    exit 0
fi

# Require confirmation
if [ "$CONFIRM" != true ]; then
    echo -e "${YELLOW}Add --confirm or -y to delete these files.${NC}"
    exit 0
fi

# Delete
echo -e "${RED}Deleting files...${NC}"

DELETED=0
while IFS= read -r file; do
    if [ -f "$file" ]; then
        # Remove associated metadata files
        rm -f "${file}.json" "${file%.*}.json"
        rm -f "$file"

        ((DELETED++))
        echo -e "${GREEN}[DELETED]${NC} $(basename "$file")"
    fi
done <<< "$FILES_TO_DELETE"

# Remove from archive
if [ -f "$ARCHIVE_FILE" ] && [ "$DELETE_ALL" = false ]; then
    # Try to clean archive entries for this user
    sed -i "/$USERNAME/d" "$ARCHIVE_FILE" 2>/dev/null || true
fi

# Remove empty directories
find "$TARGET_DIR" -type d -empty -delete 2>/dev/null || true

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Cleanup Complete${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Deleted: ${GREEN}$DELETED files${NC}"
echo -e "Freed:   ${GREEN}$TOTAL_SIZE${NC}"
echo -e "${GREEN}========================================${NC}"
