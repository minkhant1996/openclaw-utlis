#!/bin/bash
# X (Twitter) Channel Downloader
# Download posts (text, images, videos) from public X accounts
# Usage: x-channel-downloader <@username> [days|date] [options]

set -e

DOWNLOAD_DIR="$HOME/x-downloads"
ARCHIVE_FILE="$DOWNLOAD_DIR/.download-archive.txt"
CSV_LOG="$DOWNLOAD_DIR/download-history.csv"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse arguments
USERNAME=""
DATE_INPUT="7"
MEDIA_TYPE="all"  # all, video, image, text
INCLUDE_RETWEETS=false
LIMIT=""

for arg in "$@"; do
    case $arg in
        --video|-v)
            MEDIA_TYPE="video"
            ;;
        --image|--images|-i)
            MEDIA_TYPE="image"
            ;;
        --text|-t)
            MEDIA_TYPE="text"
            ;;
        --retweets|-r)
            INCLUDE_RETWEETS=true
            ;;
        --limit)
            shift
            ;;
        --help|-h)
            USERNAME="--help"
            ;;
        *)
            if [[ "$arg" =~ ^[0-9]+$ ]] && [ -z "$LIMIT" ] && [ -n "$USERNAME" ]; then
                # Check if it looks like a limit (small number after username)
                if [ "$arg" -le 7 ] || [[ "$DATE_INPUT" != "7" ]]; then
                    DATE_INPUT="$arg"
                else
                    DATE_INPUT="$arg"
                fi
            elif [[ "$arg" =~ ^@ ]] || [[ "$arg" =~ ^https://x.com ]] || [[ "$arg" =~ ^https://twitter.com ]]; then
                USERNAME="$arg"
            elif [ -z "$USERNAME" ]; then
                USERNAME="$arg"
            else
                DATE_INPUT="$arg"
            fi
            ;;
    esac
done

# Help
if [ "$USERNAME" = "--help" ] || [ -z "$USERNAME" ]; then
    echo -e "${GREEN}X (Twitter) Channel Downloader${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC} x-channel-downloader <@username> [days|date] [options]"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  x-channel-downloader @elonmusk 7              # Last 7 days, all media"
    echo "  x-channel-downloader @OpenAI 30 --video      # Last 30 days, videos only"
    echo "  x-channel-downloader @username 2024-01-15    # Since specific date"
    echo "  x-channel-downloader https://x.com/username 7"
    echo ""
    echo -e "${YELLOW}Arguments:${NC}"
    echo "  <@username>     X username (with or without @)"
    echo "  [days|date]     Days back OR specific date (YYYY-MM-DD)"
    echo "                  Default: 7 days"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  --video, -v     Download videos only"
    echo "  --image, -i     Download images only"
    echo "  --text, -t      Save text posts only (JSON)"
    echo "  --retweets, -r  Include retweets"
    echo "  --help, -h      Show this help"
    echo ""
    echo -e "${YELLOW}Output:${NC}"
    echo "  Files:    ~/x-downloads/@username/"
    echo "  Log:      ~/x-downloads/download-history.csv"
    echo ""
    echo -e "${YELLOW}Requirements:${NC}"
    echo "  - gallery-dl (pip install gallery-dl)"
    echo "  - yt-dlp (for video downloads)"
    exit 0
fi

# Extract username
USERNAME=$(echo "$USERNAME" | sed -E 's|https://(x|twitter).com/||; s|^@||; s|/.*||')

# Calculate date filter
if [[ "$DATE_INPUT" =~ ^[0-9]+$ ]]; then
    DATE_AFTER=$(date -d "$DATE_INPUT days ago" +%Y-%m-%d)
    DATE_DISPLAY="last $DATE_INPUT days"
else
    DATE_AFTER="$DATE_INPUT"
    DATE_DISPLAY="since $DATE_INPUT"
fi

# Create directories
USER_DIR="$DOWNLOAD_DIR/@$USERNAME"
mkdir -p "$USER_DIR"

# Initialize CSV if not exists
if [ ! -f "$CSV_LOG" ]; then
    echo "post_id,username,date,type,text,media_count,file_path,download_date" > "$CSV_LOG"
fi

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}X (Twitter) Channel Downloader${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Account: ${YELLOW}@$USERNAME${NC}"
echo -e "Filter:  ${YELLOW}$DATE_DISPLAY${NC} (after $DATE_AFTER)"
echo -e "Media:   ${BLUE}$MEDIA_TYPE${NC}"
echo -e "Output:  ${YELLOW}$USER_DIR${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# Check for gallery-dl
if ! command -v gallery-dl &> /dev/null; then
    echo -e "${RED}Error: gallery-dl not installed${NC}"
    echo "Install with: pipx install gallery-dl"
    echo "         or: pip install gallery-dl"
    exit 1
fi

# Build gallery-dl command
GALLERY_OPTS=""

# Date filter
GALLERY_OPTS="$GALLERY_OPTS --filter \"date >= datetime.strptime('$DATE_AFTER', '%Y-%m-%d')\""

# Media type filter
case $MEDIA_TYPE in
    video)
        GALLERY_OPTS="$GALLERY_OPTS --filter \"extension in ('mp4', 'mov', 'webm')\""
        ;;
    image)
        GALLERY_OPTS="$GALLERY_OPTS --filter \"extension in ('jpg', 'jpeg', 'png', 'gif', 'webp')\""
        ;;
esac

# Retweets filter
if [ "$INCLUDE_RETWEETS" = false ]; then
    GALLERY_OPTS="$GALLERY_OPTS --filter \"not retweet\""
fi

# Output template
OUTPUT_TEMPLATE="$USER_DIR/{date:%Y%m%d}_{tweet_id}_{num}.{extension}"

echo -e "${YELLOW}Downloading from @$USERNAME...${NC}"
echo ""

# Create a config for gallery-dl
CONFIG_FILE=$(mktemp)
cat > "$CONFIG_FILE" << EOF
{
    "extractor": {
        "twitter": {
            "cards": true,
            "conversations": false,
            "pinned": false,
            "quoted": true,
            "replies": false,
            "retweets": $( [ "$INCLUDE_RETWEETS" = true ] && echo "true" || echo "false" ),
            "text-tweets": $( [ "$MEDIA_TYPE" = "text" ] && echo "true" || echo "false" ),
            "videos": true,
            "filename": "{date:%Y%m%d}_{tweet_id}_{num}.{extension}",
            "directory": ["x-downloads", "@{author[name]}"],
            "postprocessors": [
                {
                    "name": "metadata",
                    "mode": "json"
                }
            ]
        }
    },
    "downloader": {
        "archive": "$ARCHIVE_FILE"
    }
}
EOF

# Run gallery-dl
cd "$DOWNLOAD_DIR"

# Use eval to properly handle the filter options
DOWNLOAD_CMD="gallery-dl --config '$CONFIG_FILE' -D '$USER_DIR' --download-archive '$ARCHIVE_FILE'"

# Add date filter
DOWNLOAD_CMD="$DOWNLOAD_CMD --filter \"date >= datetime(${DATE_AFTER//-/, })\""

DOWNLOAD_CMD="$DOWNLOAD_CMD 'https://x.com/$USERNAME'"

echo -e "${BLUE}Running: gallery-dl for @$USERNAME${NC}"

# Actually run it with simpler options
gallery-dl \
    --directory "$USER_DIR" \
    --download-archive "$ARCHIVE_FILE" \
    --write-metadata \
    --filename "{date:%Y%m%d}_{tweet_id}_{num}.{extension}" \
    "https://x.com/$USERNAME" 2>&1 | while read -r line; do
        if [[ "$line" == *"#"* ]]; then
            echo -e "${GREEN}[DOWNLOAD]${NC} $line"
        elif [[ "$line" == *"skip"* ]]; then
            echo -e "${YELLOW}[SKIP]${NC} $line"
        else
            echo "$line"
        fi
    done

# Cleanup
rm -f "$CONFIG_FILE"

# Count downloaded files
FILE_COUNT=$(find "$USER_DIR" -type f \( -name "*.mp4" -o -name "*.jpg" -o -name "*.png" -o -name "*.gif" \) -newer "$ARCHIVE_FILE" 2>/dev/null | wc -l || echo "0")

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Download Complete${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Account:    ${YELLOW}@$USERNAME${NC}"
echo -e "Files:      ${GREEN}$FILE_COUNT new${NC}"
echo -e "Location:   ${YELLOW}$USER_DIR${NC}"
echo -e "${GREEN}========================================${NC}"
