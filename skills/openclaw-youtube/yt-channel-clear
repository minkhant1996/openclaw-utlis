#!/bin/bash
# YouTube Downloads Cleaner
# Usage: yt-channel-clear [channel] [options]
# Examples:
#   yt-channel-clear                              # List all channels
#   yt-channel-clear @ChannelName                 # Delete all from channel
#   yt-channel-clear @ChannelName --older 30     # Delete older than 30 days
#   yt-channel-clear --all                        # Delete everything

DOWNLOAD_DIR="$HOME/youtube-downloads"
ARCHIVE_FILE="$DOWNLOAD_DIR/.download-archive.txt"
CSV_LOG="$DOWNLOAD_DIR/download-history.csv"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse arguments
CHANNEL=""
OLDER_THAN=""
DELETE_ALL=false
CONFIRM=false
DRY_RUN=false
FORMAT_FILTER=""

for arg in "$@"; do
    case $arg in
        --all|-A)
            DELETE_ALL=true
            ;;
        --older)
            shift
            ;;
        --confirm|-y)
            CONFIRM=true
            ;;
        --dry-run|-n)
            DRY_RUN=true
            ;;
        --mp3)
            FORMAT_FILTER="mp3"
            ;;
        --video)
            FORMAT_FILTER="video"
            ;;
        --help|-h)
            CHANNEL="--help"
            ;;
        *)
            if [[ "$arg" =~ ^[0-9]+$ ]] && [ -z "$OLDER_THAN" ]; then
                OLDER_THAN="$arg"
            elif [ -z "$CHANNEL" ]; then
                CHANNEL="$arg"
            fi
            ;;
    esac
done

# Help
if [ "$CHANNEL" = "--help" ]; then
    echo -e "${GREEN}YouTube Downloads Cleaner${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC} yt-channel-clear [channel] [options]"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  yt-channel-clear                              # List all channels & sizes"
    echo "  yt-channel-clear @ChannelName --confirm       # Delete all from channel"
    echo "  yt-channel-clear @ChannelName --older 30 -y   # Delete older than 30 days"
    echo "  yt-channel-clear --all --confirm              # Delete everything"
    echo "  yt-channel-clear @Channel --mp3 --confirm     # Delete only MP3s"
    echo "  yt-channel-clear @Channel --dry-run           # Preview without deleting"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  --older <days>      Only delete files older than N days"
    echo "  --mp3               Only delete MP3 files"
    echo "  --video             Only delete video files"
    echo "  --all, -A           Delete all downloads (all channels)"
    echo "  --confirm, -y       Actually delete (required for deletion)"
    echo "  --dry-run, -n       Preview what would be deleted"
    echo "  --help, -h          Show this help"
    echo ""
    echo -e "${YELLOW}Storage:${NC}"
    echo "  Files:    ~/youtube-downloads/"
    echo "  Log:      ~/youtube-downloads/download-history.csv"
    exit 0
fi

# Check if download directory exists
if [ ! -d "$DOWNLOAD_DIR" ]; then
    echo -e "${YELLOW}No downloads directory found.${NC}"
    exit 0
fi

# List channels if no specific channel given
if [ -z "$CHANNEL" ] && [ "$DELETE_ALL" = false ]; then
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Downloaded Channels${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""

    TOTAL_SIZE=0
    TOTAL_FILES=0

    for dir in "$DOWNLOAD_DIR"/*/; do
        if [ -d "$dir" ]; then
            CHANNEL_NAME=$(basename "$dir")
            FILE_COUNT=$(find "$dir" -type f \( -name "*.mp4" -o -name "*.webm" -o -name "*.mkv" -o -name "*.mp3" \) 2>/dev/null | wc -l)
            DIR_SIZE=$(du -sh "$dir" 2>/dev/null | cut -f1)

            if [ "$FILE_COUNT" -gt 0 ]; then
                echo -e "${YELLOW}$CHANNEL_NAME${NC}"
                echo -e "  Files: $FILE_COUNT | Size: $DIR_SIZE"
                ((TOTAL_FILES+=FILE_COUNT))
            fi
        fi
    done

    TOTAL_SIZE=$(du -sh "$DOWNLOAD_DIR" 2>/dev/null | cut -f1)

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "Total: ${YELLOW}$TOTAL_FILES files${NC} | ${YELLOW}$TOTAL_SIZE${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "To delete: ${BLUE}yt-channel-clear <channel_name> --confirm${NC}"
    exit 0
fi

# Determine target directory
if [ "$DELETE_ALL" = true ]; then
    TARGET_DIR="$DOWNLOAD_DIR"
    TARGET_NAME="ALL DOWNLOADS"
else
    # Normalize channel name
    CHANNEL=$(echo "$CHANNEL" | sed 's|.*/||')  # Remove URL prefix if any
    TARGET_DIR="$DOWNLOAD_DIR/$CHANNEL"
    TARGET_NAME="$CHANNEL"

    if [ ! -d "$TARGET_DIR" ]; then
        echo -e "${RED}Channel not found: $CHANNEL${NC}"
        echo "Available channels:"
        ls -1 "$DOWNLOAD_DIR" 2>/dev/null | grep -v "^\\." | grep -v "\\.csv$" | grep -v "\\.txt$"
        exit 1
    fi
fi

# Build find command
FIND_OPTS="-type f \( -name '*.mp4' -o -name '*.webm' -o -name '*.mkv' -o -name '*.mp3' -o -name '*.m4a' \)"

if [ -n "$FORMAT_FILTER" ]; then
    if [ "$FORMAT_FILTER" = "mp3" ]; then
        FIND_OPTS="-type f \( -name '*.mp3' -o -name '*.m4a' \)"
    else
        FIND_OPTS="-type f \( -name '*.mp4' -o -name '*.webm' -o -name '*.mkv' \)"
    fi
fi

if [ -n "$OLDER_THAN" ]; then
    FIND_OPTS="$FIND_OPTS -mtime +$OLDER_THAN"
fi

# Find files to delete
FILES_TO_DELETE=$(eval "find \"$TARGET_DIR\" $FIND_OPTS" 2>/dev/null)

if [ -z "$FILES_TO_DELETE" ]; then
    echo -e "${YELLOW}No files found matching criteria.${NC}"
    exit 0
fi

FILE_COUNT=$(echo "$FILES_TO_DELETE" | wc -l)
TOTAL_SIZE=$(echo "$FILES_TO_DELETE" | xargs du -ch 2>/dev/null | tail -1 | cut -f1)

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Files to Delete${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Target:  ${YELLOW}$TARGET_NAME${NC}"
[ -n "$OLDER_THAN" ] && echo -e "Filter:  ${YELLOW}Older than $OLDER_THAN days${NC}"
[ -n "$FORMAT_FILTER" ] && echo -e "Format:  ${YELLOW}$FORMAT_FILTER only${NC}"
echo -e "Files:   ${RED}$FILE_COUNT${NC}"
echo -e "Size:    ${RED}$TOTAL_SIZE${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# List files
echo -e "${YELLOW}Files:${NC}"
echo "$FILES_TO_DELETE" | while read -r file; do
    SIZE=$(du -h "$file" 2>/dev/null | cut -f1)
    echo "  $SIZE  $(basename "$file")"
done | head -20

if [ "$FILE_COUNT" -gt 20 ]; then
    echo "  ... and $((FILE_COUNT - 20)) more files"
fi
echo ""

# Dry run mode
if [ "$DRY_RUN" = true ]; then
    echo -e "${BLUE}[DRY RUN] No files deleted.${NC}"
    exit 0
fi

# Require confirmation
if [ "$CONFIRM" != true ]; then
    echo -e "${YELLOW}Add --confirm or -y to actually delete these files.${NC}"
    echo -e "Example: yt-channel-clear $CHANNEL --confirm"
    exit 0
fi

# Delete files
echo -e "${RED}Deleting files...${NC}"

DELETED=0
while IFS= read -r file; do
    if [ -f "$file" ]; then
        # Extract video ID from filename
        VIDEO_ID=$(echo "$file" | grep -oP '\[([a-zA-Z0-9_-]{11})\]' | tr -d '[]')

        rm -f "$file"

        # Also remove .info.json if exists
        rm -f "${file%.*}.info.json"

        # Remove from archive
        if [ -n "$VIDEO_ID" ] && [ -f "$ARCHIVE_FILE" ]; then
            sed -i "/$VIDEO_ID/d" "$ARCHIVE_FILE" 2>/dev/null
        fi

        ((DELETED++))
        echo -e "${GREEN}[DELETED]${NC} $(basename "$file")"
    fi
done <<< "$FILES_TO_DELETE"

# Remove empty directories
if [ "$DELETE_ALL" = true ]; then
    find "$DOWNLOAD_DIR" -type d -empty -delete 2>/dev/null
else
    rmdir "$TARGET_DIR" 2>/dev/null || true
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Cleanup Complete${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "Deleted: ${GREEN}$DELETED files${NC}"
echo -e "Freed:   ${GREEN}$TOTAL_SIZE${NC}"
echo -e "${GREEN}========================================${NC}"
